<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Saviora</title>
  <link rel="icon" type="image/png" href="src/savlogo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --secondary: #64748b;
      --accent: #06b6d4;
      --background: #bdcff1;
      --card-bg: rgba(255, 255, 255, 0.92);
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --border: rgba(0, 0, 0, 0.1);
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);

      --chat-bg: rgba(255,255,255,0.82);
      --menu-bg: rgba(255,255,255,0.98);
      --menu-text: #111827;

      --panel-max-width: 768px;
      --surface-height-desktop: 380px;
      --surface-height-mobile: 50vh;
      --surface-height: var(--surface-height-desktop);
      --keyboard-height: 0px;
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      
      --progress-active: #2563eb;
      --progress-inactive: #e2e8f0;
      --progress-completed: #10b981;
    }

    [data-theme="dark"] {
      --background: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.92);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: rgba(255, 255, 255, 0.1);
      --chat-bg: rgba(30, 41, 59, 0.82);
      --menu-bg: rgba(30, 41, 59, 0.98);
      --menu-text: #f1f5f9;
      --progress-inactive: #334155;
    }

    html, body {
      width: 100vw;
      max-width: 100vw;
      height: 100%;
      overflow-x: hidden;
      box-sizing: border-box;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }
    
    body {
      font-family: var(--font-family);
      margin: 0;
      padding: 16px;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding-top: env(safe-area-inset-top, 0px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
      padding-left: max(env(safe-area-inset-left, 0px), 16px);
      padding-right: max(env(safe-area-inset-right, 0px), 16px);
    }

    input, button, textarea, select {
  font-family: inherit;
  font-size: inherit;
}

/* –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
#auth { display: none; }

    .theme-toggle {
      position: fixed;
      top: max(18px, env(safe-area-inset-top, 18px));
      right: max(18px, env(safe-area-inset-right, 18px));
      z-index: 100;
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 16px;
      font-size: 15px;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: background 0.2s, color 0.2s;
      user-select: none;
    }
    .theme-toggle:active { transform: scale(0.97); }

    .pre-auth .center-wrap { visibility: hidden; }
    #auth { display: block; }

    h1 { font-size: clamp(1.5rem, 5vw, 2rem); margin: 0 0 20px; text-align: center; font-weight: 700; color: var(--text-primary); }
    h3 { font-size: clamp(1.1rem, 4vw, 1.5rem); font-weight: 600; margin: 0; color: var(--text-primary); }

    .center-wrap, .row, .card {
      max-width: var(--panel-max-width);
      width: 100%;
      margin: 0 auto;
      box-sizing: border-box;
    }
    
    .center-wrap {
      min-height: calc(100vh - 32px);
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center;
      padding: 24px 0;
    }
    
    .row { }
    
    .card {
      position: relative;
      background: var(--card-bg);
      border-radius: 16px;
      padding: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      animation: fadeIn 0.4s ease-out;
      overflow: visible;
      scrollbar-gutter: stable both-edges;
    }

    /* Progress indicator */
    .progress-indicator {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0 auto 24px auto;
      max-width: 300px;
      width: 100%;
      position: relative;
    }

    .progress-step {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      background: var(--progress-inactive);
      color: var(--text-secondary);
      position: relative;
      z-index: 2;
      transition: all 0.3s ease;
    }

    .progress-step.active {
      background: var(--progress-active);
      color: white;
      transform: scale(1.1);
    }

    .progress-step.completed {
      background: var(--progress-completed);
      color: white;
    }

    .progress-line {
      position: absolute;
      top: 50%;
      left: 16px;
      right: 16px;
      height: 3px;
      background: var(--progress-inactive);
      transform: translateY(-50%);
      z-index: 1;
    }

    .progress-line-filled {
      position: absolute;
      top: 50%;
      left: 16px;
      height: 3px;
      background: var(--progress-active);
      transform: translateY(-50%);
      transition: width 0.4s ease;
      z-index: 1;
    }

    /* –ï–¥–∏–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –≤—Å–µ—Ö —Ä–∞–±–æ—á–∏—Ö –æ–±–ª–∞—Å—Ç–µ–π */
    .surface, .dream-view, textarea#dream, .chat-wrap.surface {
      box-sizing: border-box;
      width: 100%;
      border-radius: 12px;
      padding: 16px;
      margin: 0;
      display: block;
      min-height: var(--surface-height);
      height: var(--surface-height);
      max-height: var(--surface-height);
      font-size: 16px;
      transition: height 0.3s ease, min-height 0.3s ease;
    }

    .surface {
      background: rgba(255,255,255,0.8);
      border: 1px solid var(--border);
      overflow: hidden;
    }
    
    .dream-view {
      line-height: 1.6; 
      border: 1px dashed var(--border);
      background: rgba(255,255,255,0.8); 
      white-space: pre-wrap;
      overflow: auto;
      overflow-x: hidden;
      scrollbar-gutter: stable;
    }
    
    #dream {
      resize: none; 
      white-space: pre-wrap;
      overflow: auto;
      overflow-x: hidden;
      scrollbar-gutter: stable;
      font-family: inherit;
    }

    .chat-wrap.surface {
      padding: 0 !important;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .header-row, .dialog-header {
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 8px;
      margin-bottom: 14px;
      padding-left: 0;
    }
    
    .card .top-back + .header-row,
    .card .top-back + .dialog-header {
      padding-left: 36px;
    }

    .card .top-back {
      position: absolute; 
      top: 8px; 
      left: 8px;
      width: 28px; 
      height: 28px; 
      border-radius: 12px;
      border: 1px solid var(--border); 
      background: var(--card-bg); 
      color: var(--text-primary);
      display: inline-flex; 
      align-items: center; 
      justify-content: center;
      cursor: pointer; 
      box-shadow: var(--shadow); 
      font-size: 14px; 
      line-height: 1;
      transition: transform 0.1s ease;
    }
    
    .top-back:hover { background: rgba(0,0,0,0.04); transform: scale(0.97); }

    .controls { 
      display: flex; 
      gap: 12px; 
      flex-wrap: wrap; 
      margin-top: 16px; 
      justify-content: flex-end; 
    }
    
    .controls.left { justify-content: flex-start; }
    
    .btn {
      padding: clamp(12px, 4vw, 16px) clamp(16px, 5vw, 24px); 
      border-radius: 12px; 
      background: white; 
      cursor: pointer; 
      font-weight: 500; 
      font-size: 14px;
      transition: all 0.2s ease; 
      border: 1px solid var(--border);
      color: var(--text-primary); 
      box-shadow: var(--shadow);
      min-height: 44px;
      flex-shrink: 0;
    }
    
    .btn:hover { box-shadow: 0 6px 12px -1px rgba(0,0,0,0.15); }
    .btn.primary { background: var(--primary); color: white; border: none; font-weight: 600; }
    .btn.primary:hover { background: var(--primary-hover); }
    .btn.secondary { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
    .btn.secondary:hover { background: rgba(0,0,0,0.05); }

    .blocks { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
    
    .chip {
      padding: 6px 12px; 
      border-radius: 14px; 
      background: #e0f2fe; 
      color: #0369a1; 
      cursor: pointer; 
      border: none; 
      font-size: 12px; 
      font-weight: 500;
      transition: all 0.2s ease;
      min-height: 28px;
    }
    
    .chip:hover { background: #bae6fd; transform: translateY(-1px); }
    .chip.active { background: var(--primary); color: white; box-shadow: var(--shadow); }

    .chat-wrap { 
      position: relative; 
      flex: 1 1 auto; 
      min-height: 260px; 
      overflow: hidden; 
      padding-bottom: env(keyboard-inset-height, 0px); 
    }
    
    .chat {
      display: flex; 
      flex-direction: column; 
      gap: 12px;
      height: 100%;
      padding: 16px;
      border-radius: 12px;
      background: var(--chat-bg);
      overflow-y: auto; 
      overflow-x: hidden; 
      -webkit-overflow-scrolling: touch;
      scrollbar-gutter: stable;
      contain: paint;
      box-sizing: border-box;
    }

    .msg {
      max-width: min(85%, 560px);
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
      word-wrap: break-word;
      overflow-wrap: anywhere;
      white-space: pre-wrap;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }
    
    .bot  { background: #f1f5f9; color: var(--text-primary); align-self: flex-start; border: 1px solid #e2e8f0; }
    .user { background: var(--primary);  color: #fff; align-self: flex-end; border: none; }
    .msg.bot.final { background: #e0f2fe; color: #0c4a6e; border: 1px solid #bae6fd; }
    .msg.final-global { background: linear-gradient(135deg, #fef3c7, #fed7aa); border-left: 4px solid #f59e0b; color: #78350f; }
    .msg.thinking {
      background: transparent;
      color: var(--text-secondary);
      border: none;
      padding: 4px 8px;
      font-size: 13px;
      align-self: flex-start;
    }
    
    .chat-stabilizer { 
      height: 6px; 
      flex: 0 0 auto; 
      transition: height 0.3s ease;
    }
    
    .muted { color: var(--text-secondary); font-size: 14px; margin: 8px 0; }
    .footer { margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    
    .chat-input-bar {
      position: relative;
      width: 100%;
      min-height: 56px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      box-sizing: border-box;
    }
    
    #userInput {
      width: 100%;
      height: auto;
      min-height: 44px;
      max-height: 120px;
      padding: 12px 44px 12px 16px;
      border-radius: 20px;
      font-size: 16px;
      line-height: 1.4;
      resize: none;
      overflow: hidden;
      background: rgba(255,255,255,0.97);
      border: 1px solid var(--border);
      box-sizing: border-box;
      transition: all 0.15s ease;
      -webkit-appearance: none;
      appearance: none;
      -webkit-text-size-adjust: 100%;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) transparent;
      touch-action: manipulation;
    }
    
    #userInput::-webkit-scrollbar { width: 4px; }
    #userInput::-webkit-scrollbar-thumb { background-color: var(--primary); border-radius: 2px; }
    
    .send-icon-btn, .attach-icon-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      bottom: auto;
      width: 44px;
      height: 44px;
      border-radius: 22px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: none;
      transition: all 0.15s ease;
    }
    
    .attach-icon-btn { 
      right: 60px; 
      background: var(--card-bg); 
      color: var(--text-primary); 
      border: 1px solid var(--border); 
      font-size: 18px; 
    }
    
    .send-icon-btn { 
      right: 12px; 
      background: var(--primary); 
      color: #fff; 
      border: none; 
      font-size: 16px; 
    }

    /* –õ—É–Ω–∞ –≤–º–µ—Å—Ç–æ —Å–∫—Ä–µ–ø–∫–∏ */
#moonBtn.attach-icon-btn {
  position: absolute;
  right: 56px; /* —á—Ç–æ–±—ã –Ω–µ –Ω–∞–ª–µ–∑–∞–ª–∞ –Ω–∞ send */
  top: 50%;
  transform: translateY(-50%);
  width: 44px;
  height: 44px;
  min-width: 44px;
  min-height: 44px;
  max-width: 44px;
  max-height: 44px;
  border-radius: 50%;
  padding: 0;
  background: none;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: none;
  outline: none;
  overflow: hidden;
  z-index: 2;
}

#moonBtn:focus,
#moonBtn:active {
  box-shadow: none;
  outline: none;
}

.moon-svg {
  width: 44px;
  height: 44px;
  display: block;
}

.moon-flash {
  filter: drop-shadow(0 0 32px #f6e27a) brightness(2.1);
  transform: scale(1.22);
  animation: moonFlashAnim 1.6s cubic-bezier(.4,2,.4,1) 1;
}

@keyframes moonFlashAnim {
  0%   { filter: drop-shadow(0 0 0px #f6e27a) brightness(1); transform: scale(1);}
  20%  { filter: drop-shadow(0 0 48px #fffbe6) brightness(2.7); transform: scale(1.28);}
  60%  { filter: drop-shadow(0 0 32px #f6e27a) brightness(2.1); transform: scale(1.22);}
  100% { filter: drop-shadow(0 0 0px #f6e27a) brightness(1); transform: scale(1);}
}
    
    .send-icon-btn {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 44px;
  height: 44px;
  border-radius: 22px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: var(--primary);
  color: #fff;
  border: none;
  font-size: 16px;
  z-index: 2;
}
    
    .attach-menu {
      position: absolute; 
      right: 12px; 
      bottom: 56px;
      background: var(--menu-bg); 
      color: var(--menu-text);
      border-radius: 12px; 
      padding: 8px 0; 
      box-shadow: 0 12px 32px rgba(0,0,0,0.15);
      min-width: 220px; 
      z-index: 10; 
      animation: fadeIn 0.15s ease-out; 
      border: 1px solid var(--border);
      display: none;
    }
    
    .attach-item { 
      width: 100%; 
      text-align: left; 
      background: transparent; 
      border: none; 
      color: var(--menu-text); 
      padding: 12px 16px; 
      font-size: 14px; 
      cursor: pointer; 
      min-height: 44px; 
    }
    
    .attach-item:hover { background: rgba(0,0,0,0.04); }
    
    .jump-bottom-btn {
      position: absolute; 
      right: 16px; 
      bottom: 16px; 
      width: 44px; 
      height: 44px; 
      border-radius: 22px;
      background: var(--primary); 
      color: #fff; 
      border: none; 
      box-shadow: var(--shadow); 
      cursor: pointer;
      display: none; 
      opacity: 0.96; 
      font-size: 18px; 
      line-height: 1; 
      transition: all 0.2s ease;
      z-index: 5;
    }
    
    .jump-bottom-btn:hover { background: var(--primary-hover); }
    
    .nav-previews { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 8px; 
      margin-top: 12px; 
      align-items: stretch; 
    }
    
    .block-preview {
      min-height: 40px; 
      border-radius: 10px; 
      border: 1px dashed var(--border); 
      box-shadow: var(--shadow);
      padding: 6px 10px; 
      font-size: 11px; 
      color: var(--text-primary); 
      opacity: 0.95; 
      cursor: pointer;
      display: flex; 
      align-items: center; 
      justify-content: center; 
      text-align: center; 
      transition: all 0.2s ease;
      user-select: none; 
      overflow: hidden;
    }
    
    .block-preview .label {
      display: -webkit-box; 
      -webkit-line-clamp: 2; 
      -webkit-box-orient: vertical; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      max-width: 100%; 
      line-height: 1.25;
    }
    
    .block-preview.disabled { cursor: default; filter: grayscale(0.2); opacity: 0.8; }
    
    .back-link {
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      width: 32px; 
      height: 32px; 
      border-radius: 8px;
      border: 1px solid var(--border); 
      background: var(--card-bg); 
      color: var(--text-primary); 
      font-weight: 700; 
      cursor: pointer; 
      box-shadow: var(--shadow);
    }
    
    .back-link:hover { background: rgba(0,0,0,0.04); }
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(8px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .slide-in-right {
      animation: slideInRight 0.4s ease-out;
    }
    
    .slide-in-left {
      animation: slideInLeft 0.4s ease-out;
    }
    
    .thinking { display: none; }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 3px; }
    ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary-hover); }
    
    .quick { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 8px; 
      margin-top: 6px; 
      }
    
    .quick button {
      appearance: none; 
      -webkit-appearance: none; 
      background: var(--card-bg); 
      color: var(--text-primary);
      border: 1px solid var(--border); 
      border-radius: 12px; 
      padding: 14px 18px;
      font-size: 14px; 
      line-height: 1.2; 
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      transition: all 0.15s ease;
      white-space: nowrap;
      min-height: 48px;
      position: relative;
      top: 0;
    }
    
    .quick button:hover { border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.08); transform: translateY(-1px); }
    .quick button:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.18), 0 4px 10px rgba(0,0,0,0.08); border-color: var(--primary); }
    .quick button:active { transform: translateY(0); box-shadow: 0 2px 6px rgba(0,0,0,0.06); top: 2px; }
    
    .hint-inline { 
      margin: 6px 0 10px; 
      color: var(--text-secondary); 
      font-size: 14px; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      min-height: 32px; 
    }
    
    .hint-refresh {
      appearance: none; 
      -webkit-appearance: none; 
      background: transparent; 
      border: none; 
      cursor: pointer; 
      min-width: 36px; 
      min-height: 36px;
      padding: 6px; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      line-height: 1; 
      font-size: 17px; 
      color: var(--primary);
      opacity: 0.95; 
      position: relative; 
      z-index: 1; 
      border-radius: 8px;
      transition: all 0.12s ease;
    }
    
    .hint-refresh:hover { opacity: 1; color: var(--primary-hover); transform: scale(1.06); background: rgba(37, 99, 235, 0.06); }
    .hint-refresh:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25); }
    
    /* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 800px) {
      html, body {
        width: 100vw !important;
        max-width: 100vw !important;
        overflow-x: hidden !important;
      }
      
      body {
        padding: env(safe-area-inset-top, 0px) 
                 max(env(safe-area-inset-right, 0px), 8px) 
                 env(safe-area-inset-bottom, 0px) 
                 max(env(safe-area-inset-left, 0px), 8px) !important;
      }
      
      .center-wrap, .row, .card {
        max-width: 100% !important;
        margin: 0 !important;
      }
      
      .card {
        padding: 16px !important;
        border-left: none !important;
        border-right: none !important;
        border-radius: 16px !important;
      }
      
      .auth-card > div {
        min-width: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        border-radius: 16px !important;
        padding: 24px 16px !important;
      }
      
      .theme-toggle {
        top: max(12px, env(safe-area-inset-top, 12px));
        right: max(12px, env(safe-area-inset-right, 12px));
        padding: 6px 12px;
        font-size: 14px;
      }

      .chip {
        min-height: 32px;
        padding: 5px 10px;
      }
      
      .block-preview {
        min-height: 36px;
      }
      
      /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
      @media (max-height: 600px) {
        :root {
          --surface-height-mobile: 45vh;
        }
        
        .progress-indicator {
          margin-bottom: 16px;
        }
        
        .header-row, .dialog-header {
          margin-bottom: 10px;
        }
      }
      
      @media (max-height: 500px) {
        :root {
          --surface-height-mobile: 40vh;
        }
        
        .card {
          padding: 12px !important;
        }
        
        .surface, .dream-view, textarea#dream, .chat-wrap.surface {
          padding: 12px;
        }
      }
    }

    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    @media (max-width: 360px) {
      body {
        padding: env(safe-area-inset-top, 0px) 
                 max(env(safe-area-inset-right, 0px), 4px) 
                 env(safe-area-inset-bottom, 0px) 
                 max(env(safe-area-inset-left, 0px), 4px) !important;
      }
      
      .card {
        padding: 12px !important;
      }
      
      .progress-step {
        width: 28px;
        height: 28px;
        font-size: 12px;
      }
      
      .progress-line,
      .progress-line-filled {
        left: 14px;
        right: 14px;
      }
    }

    @media (pointer: coarse) {
      .btn, .chip, .block-preview, .quick button {
        transition: transform 0.1s ease, opacity 0.1s ease;
      }
      .btn:active, .chip:active, .block-preview:active, .quick button:active {
        transform: scale(0.97);
        opacity: 0.8;
      }
    }
    
    @media (spanning: single-fold-vertical) {
      .center-wrap {
        max-width: calc(var(--panel-max-width) * 1.3);
      }
    }
    
    [data-theme="dark"] .msg.bot {
      background: #1e293b !important;
      color: #f1f5f9 !important;
      border: 1px solid #334155 !important;
    }
    
    .header-row, .dialog-header {
      padding-left: 0 !important;
    }
    
    .card .top-back + .header-row,
    .card .top-back + .dialog-header {
      padding-left: 36px !important;
    }
    
    /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ iOS */
    @media screen and (max-width: 768px) {
      input, select, textarea {
        font-size: 16px !important;
      }
    }

.chip.active {
  outline: 3px solid #fff;
  outline-offset: 2px;
  box-shadow: 0 0 0 4px rgba(255,255,255,0.13);
  position: relative;
  z-index: 2;
  transition: outline 0.15s, box-shadow 0.15s;
  animation: chipSelectPulse 0.5s;
}
[data-theme="dark"] .chip.active {
  outline: 3px solid #fff;
  box-shadow: 0 0 0 4px rgba(255,255,255,0.13);
  animation: chipSelectPulseDark 0.5s;
}
@keyframes chipSelectPulse {
  0%   { box-shadow: 0 0 0 0 rgba(255,255,255,0.18); }
  70%  { box-shadow: 0 0 0 8px rgba(255,255,255,0.13); }
  100% { box-shadow: 0 0 0 4px rgba(255,255,255,0.13); }
}
@keyframes chipSelectPulseDark {
  0%   { box-shadow: 0 0 0 0 rgba(255,255,255,0.18); }
  70%  { box-shadow: 0 0 0 8px rgba(255,255,255,0.13); }
  100% { box-shadow: 0 0 0 4px rgba(255,255,255,0.13); }
}
    
  </style>
</head>
<body class="pre-auth">
  <button class="theme-toggle" id="themeToggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåô –¢–µ–º–∞</button>
  <div id="auth" style="display:none;">
  <div class="auth-bg" style="position:absolute;inset:0;background:var(--background);opacity:1;z-index:1;"></div>
  <div class="auth-card" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:2;">
    <div style="background:var(--card-bg);box-shadow:0 20px 60px rgba(0,0,0,0.2);border-radius:24px;padding:40px 32px;min-width:340px;max-width:90vw;display:flex;flex-direction:column;align-items:center;backdrop-filter:blur(20px);border:1px solid var(--border);">
      <h2 style="font-size:24px;font-weight:700;margin-bottom:24px;color:var(--text-primary);text-align:center;">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h2>
      <input type="password" id="authPass" placeholder="–ü–∞—Ä–æ–ª—å" style="font-size:16px; font-family: inherit; padding:16px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px; width:100%; max-width:280px; background:rgba(255,255,255,0.8); transition:all 0.2s ease; text-align:center;">
      <button id="authBtn" style="font-size:16px; font-family: inherit; padding:16px 32px; border-radius:12px; border:none; background:var(--primary); color:#fff; font-weight:600; cursor:pointer; transition:all 0.2s ease; width:100%; max-width:280px;">–í–æ–π—Ç–∏</button>
      <div id="authError" style="color: var(--error); margin-top: 16px; display: none; font-size: 14px;">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
    </div>
  </div>
</div>

  <div class="center-wrap">
    <h1>Saviora</h1>

    <!-- Progress Indicator -->
    <div class="progress-indicator">
      <div class="progress-step active" id="step1-indicator">1</div>
      <div class="progress-step" id="step2-indicator">2</div>
      <div class="progress-step" id="step3-indicator">3</div>
      <div class="progress-line"></div>
      <div class="progress-line-filled" id="progress-line-filled"></div>
    </div>

    <!-- –®–∞–≥ 1 -->
    <div id="step1">
      <div class="row">
        <div class="card">
          <div class="header-row">
            <h3>–ú—ã –≤—Å–µ–≥–¥–∞ —Ä–∞–¥—ã –Ω–æ–≤—ã–º –∏—Å—Ç–æ—Ä–∏—è–º</h3>
          </div>
          <textarea id="dream" class="surface" placeholder="–ó–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–µ —Å–Ω–æ–≤–∏–¥–µ–Ω–∏–µ..."></textarea>
          <div class="controls">
            <button id="toStep2" class="btn primary">–î–∞–ª–µ–µ ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –®–∞–≥ 2 -->
    <div id="step2" style="display:none;">
      <div class="row">
        <div class="card">
          <button id="backTo1Top" class="top-back" title="–ù–∞–∑–∞–¥">&larr;</button>
          <div class="header-row">
            <h3>–°–º—ã—Å–ª–æ–≤—ã–µ –±–ª–æ–∫–∏</h3>
          </div>

          <div class="hint-inline">
            –î–ª—è –ª—É—á—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ —Å–æ–Ω –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã. –í—ã–¥–µ–ª–∏—Ç–µ —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫¬ª –∏–ª–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π—Ç–µ ¬´–í–µ—Å—å —Ç–µ–∫—Å—Ç¬ª —Å—Ä–∞–∑—É.
            <button class="hint-refresh" id="refreshInline" title="–û–±–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏" aria-label="–û–±–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏">‚Üª</button>
          </div>

          <div class="dream-view surface" id="dreamView"></div>

          <div class="controls left" style="justify-content: space-between; align-items: center;">
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button id="addBlock" class="btn secondary">–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫</button>
              <button id="addWholeBlock" class="btn secondary">–í–µ—Å—å —Ç–µ–∫—Å—Ç</button>
            </div>
            <div style="margin-left:auto;"></div>
          </div>

          <div class="blocks" id="blocks"></div>

          <div class="controls">
            <button id="toStep3" class="btn primary">–ù–∞—á–∞—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –®–∞–≥ 3 -->
    <div id="step3" style="display:none;">
      <div class="row">
        <div class="card">
          <button id="backTo2Top" class="top-back" title="–ù–∞–∑–∞–¥">&larr;</button>
          <div class="dialog-header">
            <h3>–î–∏–∞–ª–æ–≥ –ø–æ –≤–∞—à–µ–º—É —Å–Ω–æ–≤–∏–¥–µ–Ω–∏—é</h3>
          </div>
          <div id="currentBlock" class="muted" style="margin: 0 0 8px;">–ë–ª–æ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
          <div class="chat-wrap surface">
            <div class="chat" id="chat">
              <div id="thinking" class="msg thinking" style="display:none;">–î—É–º–∞—é<span class="dots">...</span></div>
              <div class="chat-stabilizer"></div>
            </div>
            <button id="jumpToBottom" class="jump-bottom-btn" title="–í –∫–æ–Ω–µ—Ü">‚ñº</button>
          </div>
          <div class="footer">
            <div id="chatInputBar" class="chat-input-bar" style="width:100%; position:relative;">
              <textarea id="userInput" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å Saviora..." rows="1"></textarea>
              <button id="moonBtn" class="attach-icon-btn" title="–ü—Ä–æ–≥—Ä–µ—Å—Å –ª—É–Ω—ã" tabindex="0" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å –ª—É–Ω—ã"></button>
              <div id="attachMenu" class="attach-menu">
                <button id="menuBlockInterpret" class="attach-item">üìñ –¢–æ–ª–∫–æ–≤–∞–Ω–∏–µ</button>
                <button id="menuFinalInterpret" class="attach-item">üéØ –ò—Ç–æ–≥</button>
              </div>
              <button id="sendAnswerBtn" class="send-icon-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
            </div>
          </div>
          <div class="nav-previews">
            <div id="prevPreview" class="block-preview disabled"><span class="label">‚Ä¶</span></div>
            <div id="nextPreview" class="block-preview"><span class="label"></span></div>
          </div>

          <!-- –°–∫—Ä—ã—Ç—ã–µ —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
          <div style="display:none;">
            <button id="blockInterpretBtn">–¢–æ–ª–∫–æ–≤–∞–Ω–∏–µ</button>
            <button id="finalInterpretBtn">–ò—Ç–æ–≥</button>
            <button id="prevBlockBtn">‚óÄ</button>
            <button id="nextBlockBtn">‚ñ∂</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="src/main.js"></script>
  <script>
    // ====== Theme toggle ======
    const themeBtn = document.getElementById('themeToggle');
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('saviora_theme', theme);
      themeBtn.textContent = theme === 'dark' ? 'üåô –¢–µ–º–∞' : '‚òÄÔ∏è –¢–µ–º–∞';
    }
    function getPreferredTheme() {
      const saved = localStorage.getItem('saviora_theme');
      if (saved) return saved;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    themeBtn.onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || getPreferredTheme();
      setTheme(current === 'dark' ? 'light' : 'dark');
    };
    setTheme(getPreferredTheme());
  </script>
</body>
</html>
